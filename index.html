<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Devocional - Caminhando na Palavra</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#9ca3af;--glass:rgba(255,255,255,0.03)}
    *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    html,body{height:100%}
    body{margin:0;min-height:100vh;background:linear-gradient(180deg,#071026 0%, #061526 100%);color:#e6eef6;display:flex;align-items:center;justify-content:center;padding:28px}
    .app{width:1024px;max-width:96%;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,0.6);overflow:hidden;display:grid;grid-template-columns:1fr 420px;gap:0}
    header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.03)}
    header h1{font-size:18px;margin:0;color:var(--accent)}
    header p{margin:0;color:var(--muted);font-size:13px}
    .left{padding:22px}
    label{display:block;font-size:13px;margin-bottom:8px;color:var(--muted)}
    textarea{width:100%;min-height:140px;background:transparent;border:1px solid rgba(255,255,255,0.04);padding:12px;border-radius:8px;color:inherit;resize:vertical}
    select,input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .row{display:flex;gap:12px;margin-top:12px}
    .controls{display:flex;gap:8px;margin-top:12px;align-items:center}
    button{background:var(--accent);border:none;padding:10px 14px;border-radius:10px;color:#042029;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(255,255,255,0.03)}
    .right{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));padding:20px;border-left:1px solid rgba(255,255,255,0.03)}
    .preview{background:var(--glass);padding:16px;border-radius:10px;min-height:160px;max-height:520px;overflow:auto;white-space:pre-wrap}
    .meta{display:flex;justify-content:space-between;gap:12px;margin-bottom:10px}
    .small{font-size:13px;color:var(--muted)}
    .history{margin-top:14px}
    .hist-item{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;margin-bottom:8px;cursor:pointer}
    footer{grid-column:1/-1;padding:12px 18px;background:rgba(0,0,0,0.04);font-size:13px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    .note{font-size:12px;color:#cbd5e1}
    .flex{display:flex;gap:8px;align-items:center}
    .spinner{width:18px;height:18px;border:3px solid rgba(255,255,255,0.06);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:980px){
      .app{grid-template-columns:1fr; padding:16px}
      .right{order:3;border-left:none;border-top:1px solid rgba(255,255,255,0.03)}
      .app{width:96%}
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Gerador de Devocionais">
    <header>
      <div>
        <h1>üåø Caminhando na Palavra ‚Äî Devocionais</h1>
        <p>Gerador devocional baseado no evangelho (NAA). Chamada segura via seu backend no Render.</p>
      </div>
      <div class="flex">
        <div class="small">Vers√£o-alvo: NAA</div>
      </div>
    </header>

    <main class="left">
      <label for="verse">Verso ou Refer√™ncia</label>
      <textarea id="verse" placeholder="Ex.: Jo√£o 3:16 ‚Äî ou cole parte do texto (m√°x 90 caracteres)"></textarea>

      <div style="margin-top:12px;display:flex;gap:12px;align-items:center;">
        <div style="flex:1">
          <label for="tone">Tom</label>
          <select id="tone" aria-label="Tom">
            <option>Reflexivo</option>
            <option>Aplicativo</option>
            <option>Encerramento de culto</option>
            <option>Para jovens</option>
          </select>
        </div>
        <div style="width:220px">
          <label for="length">Tamanho</label>
          <select id="length" aria-label="Tamanho">
            <option>Curto (1-2 par√°grafos)</option>
            <option>M√©dio (3-4 par√°grafos)</option>
            <option>Longo (5-7 par√°grafos)</option>
          </select>
        </div>
      </div>

      <div class="controls" role="group" aria-label="Controles">
        <!-- removi o input de API key: a chave fica no backend -->
        <button id="generate">Gerar</button>
        <button id="save" class="ghost" type="button">Salvar</button>
        <button id="clear" class="ghost" type="button">Limpar</button>
      </div>

      <div style="margin-top:10px;color:var(--muted);font-size:13px">
        Observa√ß√£o: a chave OpenRouter deve estar armazenada no servidor (Render). Este front-end envia apenas os par√¢metros: <code>verse</code>, <code>tone</code>, <code>length</code>.
      </div>

      <div class="history" aria-live="polite">
        <h3 style="margin:12px 0 8px 0;font-size:14px;color:var(--muted)">Hist√≥rico</h3>
        <div id="historyList"></div>
      </div>
    </main>

    <aside class="right">
      <div class="meta">
        <div>
          <div class="small">Pr√©-visualiza√ß√£o</div>
          <div class="small">Sa√≠da gerada pelo servidor</div>
        </div>
        <div class="small">Salvo localmente</div>
      </div>

      <div class="preview" id="preview" tabindex="0">Seu devocional aparecer√° aqui.</div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="copy">Copiar</button>
        <button id="download" class="ghost">Baixar .txt</button>
      </div>

      <div style="margin-top:14px;color:var(--muted);font-size:13px">
        Se o servidor retornar erro, o app gera uma vers√£o local simples como fallback.
      </div>
    </aside>

    <footer>
      <div class="note">App pronto ‚Ä¢ Backend: <code>https://caminhando-api-1.onrender.com</code></div>
      <div class="small">Se quiser, eu gero tamb√©m o c√≥digo do servidor (Node/Express) que usa a chave com seguran√ßa.</div>
    </footer>
  </div>

  <script>
    // CONFIG
    const BACKEND_URL = 'https://caminhando-api-1.onrender.com'; // seu endpoint Render (fornecido)
    // Se seu backend precisa de um caminho espec√≠fico, altere aqui (ex: BACKEND_URL + '/generate')

    // UI elements
    const verseEl = document.getElementById('verse');
    const preview = document.getElementById('preview');
    const generateBtn = document.getElementById('generate');
    const copyBtn = document.getElementById('copy');
    const downloadBtn = document.getElementById('download');
    const historyList = document.getElementById('historyList');
    const saveBtn = document.getElementById('save');
    const clearBtn = document.getElementById('clear');

    // History management
    function renderHistory(){
      const h = JSON.parse(localStorage.getItem('dev_hist') || '[]');
      historyList.innerHTML = '';
      h.slice().reverse().forEach((it, idx) => {
        const d = document.createElement('div');
        d.className = 'hist-item';
        d.textContent = it.title || (it.verse || 'Devocional salvo');
        d.title = new Date(it.date).toLocaleString();
        d.onclick = () => { preview.textContent = it.text; };
        historyList.appendChild(d);
      });
    }
    renderHistory();

    function saveToHistory(title, text, verse){
      const arr = JSON.parse(localStorage.getItem('dev_hist') || '[]');
      arr.push({ title: title || ('Devocional ' + new Date().toLocaleString()), text, verse, date: new Date().toISOString() });
      localStorage.setItem('dev_hist', JSON.stringify(arr.slice(-100)));
      renderHistory();
    }

    // Local fallback generator (light)
    function simpleLocalGenerate({verse, tone, length}) {
      const lines = [];
      if (verse) lines.push(`Base: ${verse}`);
      lines.push(`Reflex√£o (${tone}): Deus nos chama a viver esta verdade de maneira pr√°tica.`);
      if (length.includes('Curto')) {
        lines.push('Uma curta medita√ß√£o: permita que o vers√≠culo molde sua atitude hoje.');
        lines.push('Ora√ß√£o: Senhor, ajuda-me a aplicar esta verdade.');
      } else if (length.includes('M√©dio')) {
        lines.push('Leitura e aplica√ß√£o: pense em um passo concreto para esta semana.');
        lines.push('Compartilhe com algu√©m e ore por direcionamento.');
        lines.push('Ora√ß√£o: Senhor, d√°-me sabedoria e coragem.');
      } else {
        lines.push('Reflex√£o estendida: pe√ßa discernimento para viver a palavra em a√ß√µes di√°rias.');
        lines.push('Liste mudan√ßas pr√°ticas e pe√ßa ao Esp√≠rito for√ßa para perseverar.');
        lines.push('Ora√ß√£o: Senhor, sustenta-nos e transforma-nos pela Tua palavra.');
      }
      return lines.join('\n\n');
    }

    // Attempt to extract text from multiple response shapes
    function extractTextFromResponse(data) {
      // OpenAI-style: choices[0].message.content
      if (data?.choices?.[0]?.message?.content) return data.choices[0].message.content;
      // older OpenAI style: choices[0].text
      if (data?.choices?.[0]?.text) return data.choices[0].text;
      // simple wrapper: { text: "..." } or { result: "..."}
      if (typeof data.text === 'string') return data.text;
      if (typeof data.result === 'string') return data.result;
      // raw string response
      if (typeof data === 'string') return data;
      // unknown shape
      return null;
    }

    async function generateDevotional() {
      const verse = verseEl.value.trim();
      const tone = document.getElementById('tone').value;
      const length = document.getElementById('length').value;

      preview.textContent = '';
      preview.dataset.loading = 'true';
      preview.innerHTML = '<span class="spinner" aria-hidden="true"></span> Gerando...';

      // Build payload for your backend ‚Äî minimal and explicit.
      const payload = { verse, tone, length };

      try {
        const resp = await fetch(BACKEND_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
            // sem Authorization aqui ‚Äî a chave deve estar no servidor
          },
          body: JSON.stringify(payload),
          // timeout handling not native; can be added with AbortController if desired
        });

        if (!resp.ok) {
          // Try to read text for debugging
          let t;
          try { t = await resp.text(); } catch(e){ t = '';}
          throw new Error(`Servidor retornou ${resp.status}: ${t}`);
        }

        const data = await resp.json().catch(async () => {
          // caso n√£o seja JSON, tentar texto
          const txt = await resp.text();
          return txt;
        });

        const text = extractTextFromResponse(data);
        if (text) {
          preview.textContent = text;
          saveToHistory(verse || ('Devocional ' + new Date().toLocaleString()), text, verse);
        } else {
          // Se servidor retornou formato inesperado, mostrar conte√∫do completo p/ debug
          preview.textContent = 'Resposta do servidor em formato inesperado.\n\n' + JSON.stringify(data, null, 2);
        }

      } catch (err) {
        // fallback local
        const local = simpleLocalGenerate({ verse, tone, length });
        preview.textContent = `‚ö†Ô∏è Erro ao conectar ao servidor: ${err.message}\n\nGerando vers√£o local como fallback:\n\n${local}`;
        saveToHistory(verse || ('Devocional local ' + new Date().toLocaleString()), local, verse);
      } finally {
        delete preview.dataset.loading;
      }
    }

    // UI events
    generateBtn.addEventListener('click', generateDevotional);
    // allow Cmd/Ctrl+Enter in textarea to generate
    verseEl.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') generateDevotional();
    });

    copyBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(preview.textContent || '').then(() => {
        alert('Copiado para a √°rea de transfer√™ncia.');
      }).catch(() => { alert('Falha ao copiar.'); });
    });

    downloadBtn.addEventListener('click', () => {
      const text = preview.textContent || '';
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'devocional.txt';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    saveBtn.addEventListener('click', () => {
      const text = preview.textContent || '';
      if (!text) return alert('Nada a salvar.');
      const title = prompt('T√≠tulo curto para salvar (opcional):', (verseEl.value || '').slice(0,40)) || ('Devocional ' + new Date().toLocaleString());
      saveToHistory(title, text, verseEl.value.trim());
      alert('Salvo localmente.');
    });

    clearBtn.addEventListener('click', () => {
      verseEl.value = '';
      preview.textContent = 'Seu devocional aparecer√° aqui.';
    });

    // initial accessibility focus
    preview.setAttribute('aria-live', 'polite');
  </script>
</body>
</html>
